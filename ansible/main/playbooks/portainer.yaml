---
- name: Setup Portainer
  hosts: portainer
  become: true
  serial: 1

  vars:
    data_path: /home/player/data
    user_home: /home/player

  pre_tasks:
    - name: Replace DNS entry
      replace: # point to the local adguard instance instead of the systemd-resolved ip
        path: /etc/resolv.conf
        regexp: '^nameserver 127.0.0.53$'
        replace: 'nameserver 127.0.0.1'

    - name: Prepare data directory
      ansible.builtin.file:
        path: '{{ item }}'
        state: directory
        owner: player
        group: player
      loop:
        - '{{ data_path }}/adguard'
        - '{{ data_path }}/portainer'

  roles:
    - ubuntu
    - geerlingguy.docker
    - geerlingguy.node_exporter
    - role: geerlingguy.nfs
      nfs_exports:
        # Map all nfs access as user:group (player:player)
        - /mnt/hdd/media *(sec=sys,all_squash,anonuid=1000,anongid=1000,rw,sync,no_subtree_check,fsid=1)
    - dockernonroot
    - name: 'Setup tailscale as a subnet advertiser'
      role: artis3n.tailscale
    - name: Setup postgres cluster on docker & the necessary backup scripts
      role: postgres

  # tasks:
  #   - name: Setup adguard home
  #   - name: Setup Portainer
