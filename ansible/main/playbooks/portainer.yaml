---
- name: Setup Portainer
  hosts: portainer
  become: true
  serial: 1

  vars:
    user_name: player

  roles:
    - ubuntu

    - name: Setup nfs server
      role: geerlingguy.nfs
      vars:
        nfs_exports:
          # Map all nfs access as user:group (player:player)
          - /mnt/hdd/media *(sec=sys,all_squash,anonuid=1000,anongid=1000,rw,sync,no_subtree_check,fsid=1)
          - /mnt/hdd/kubernetes *(sec=sys,all_squash,anonuid=1000,anongid=1000,rw,sync,no_subtree_check,fsid=2)

    - name: Schedule backup to nas
      role: ansible-systemd-timers
      vars:
        timers:
          songs-backup:
            timer_command: rsync -avhP --no-times /mnt/hdd/media/music truenas:/mnt/mega/aditya
            timer_OnCalendar: '*-*-* 02:00:00'
            timer_user: '{{ user_name }}'
