---
# Install restic and sets up systemd timer to perform scheduled backup
#

- hosts: truenas
  become: true

  vars:
    restic_version: 0.18.0
    restic_path: /usr/bin/restic
    rclone_version: '1.67.0'

  # pre_tasks:
  #   - name: Download restic
  #     ansible.builtin.get_url:
  #       url: 'https://github.com/restic/restic/releases/download/v{{ restic_version }}/restic_{{ restic_version }}_linux_amd64.bz2'
  #       dest: '/tmp/restic_{{ restic_version }}_linux_amd64.bz2'

  #   - name: Extract restic
  #     command: 'bzip2 -dk /tmp/restic_{{ restic_version }}_linux_amd64.bz2'
  #     args:
  #       creates: '/tmp/restic_{{ restic_version }}_linux_amd64'

  #   - name: Install restic
  #     ansible.builtin.copy:
  #       remote_src: true
  #       src: '/tmp/restic_{{ restic_version }}_linux_amd64'
  #       dest: '{{ restic_path }}'
  #       mode: 0755

  pre_tasks:
    - name: Create rclone backup script with mount verification
      ansible.builtin.copy:
        dest: /home/admin/rclone-nas-backup.sh
        mode: '0755'
        owner: admin
        content: |
          #!/bin/bash
          if ! mountpoint -q /mnt/seagate || [ ! "$(ls -A /mnt/seagate/backups)" ]; then
            echo "ERROR: /mnt/seagate not mounted or backups directory empty. Aborting rclone sync."
            exit 1
          fi
          rclone sync /mnt/seagate/backups b2:{{ b2_nas_backup }} -v --progress

  roles:
    - name: Installs restic & sets up scheduled backup to external HDD
      role: ansible-restic
      vars:
        restic_user: root
        restic_folders:
          - {
              path: '/mnt/mega/aditya',
              exclude: '--exclude-file=/mnt/mega/aditya/.resticignore',
            }
          - {
              path: '/mnt/mega/photos',
              exclude: '--exclude-file=/mnt/mega/photos/.resticignore',
            }
        restic_default_folders: [] # don't backup the default folders
        restic_ssh_enabled: false
        restic_repository: /mnt/seagate/backups
        restic_repository_name: /mnt/seagate/backups
        restic_systemd_timer_on_calender: '*-*-* 03:00:00'
        restic_forget_keep_within: 90d

    - name: Install and configure rclone
      role: ansible-rclone

    - name: Setup systemd timers for rclone backup to Backblaze
      role: ansible-systemd-timers
      vars:
        timers:
          rclone-nas-backup:
            timer_command: bash /home/admin/rclone-nas-backup.sh
            timer_OnCalendar: '*-*-1/2 04:30:00'
            timer_user: 'root'

  # tasks:
  #   - name: Setup NAS ssh
  #     ansible.posix.authorized_key:
  #       user: admin
  #       state: present
  #       key: '../files/proxmox-player.pub'
