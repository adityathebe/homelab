---
apiVersion: batch/v1
kind: Job
metadata:
  name: navidrome-data-migration
  namespace: music
spec:
  template:
    spec:
      nodeSelector:
        kubernetes.io/hostname: saka
      restartPolicy: Never
      containers:
        - name: migration
          image: alpine:latest
          command:
            - /bin/sh
            - -c
            - |
              # Install rsync
              apk add --no-cache rsync

              echo "Starting migration from hostPath to Longhorn PVC..."
              echo "Source (hostPath): $(ls -la /source/)"
              echo "Destination (Longhorn): $(ls -la /destination/)"

              # Sync all data from hostPath to Longhorn PVC with progress
              rsync -azvPh --progress /source/ /destination/

              # Verify the sync
              echo "Migration completed. Verifying..."
              echo "Source size: $(du -sh /source)"
              echo "Destination size: $(du -sh /destination)"

              # List contents for verification
              echo "Source contents:"
              find /source -type f | head -20
              echo "Destination contents:"
              find /destination -type f | head -20

              echo "Migration job completed successfully!"
          volumeMounts:
            - name: source-data
              mountPath: /source
              readOnly: true
            - name: destination-data
              mountPath: /destination
      volumes:
        - name: source-data
          hostPath:
            path: /home/player/kube_data/navidrome
            type: Directory
        - name: destination-data
          persistentVolumeClaim:
            claimName: navidrome-data
