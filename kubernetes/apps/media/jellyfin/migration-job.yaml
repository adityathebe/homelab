---
apiVersion: batch/v1
kind: Job
metadata:
  name: jellyfin-config-migration
  namespace: media
spec:
  template:
    spec:
      nodeSelector:
        kubernetes.io/hostname: saka
      restartPolicy: Never
      containers:
        - name: migration
          image: alpine:latest
          command:
            - /bin/sh
            - -c
            - |
              # Install rsync
              apk add --no-cache rsync

              echo "Starting migration from hostPath to Longhorn PVC..."
              echo "Source (hostPath): $(ls -la /source/)"
              echo "Destination (Longhorn): $(ls -la /destination/)"

              # Sync all data from hostPath to Longhorn PVC with progress
              rsync -azvPh --progress --delete /source/ /destination/

              # List contents for verification
              echo "Source contents:"
              cd /source
              du -hs *
              echo "Destination contents:"
              cd /destination
              du -hs *

              echo "Migration job completed successfully!"
          volumeMounts:
            - name: source-data
              mountPath: /source
              readOnly: true
            - name: destination-data
              mountPath: /destination
      volumes:
        - name: source-data
          hostPath:
            path: /home/player/kube_data/jellyfin/config
            type: Directory
        - name: destination-data
          persistentVolumeClaim:
            claimName: jellyfin-config
---
apiVersion: batch/v1
kind: Job
metadata:
  name: jellyfin-cache-migration
  namespace: media
spec:
  template:
    spec:
      nodeSelector:
        kubernetes.io/hostname: saka
      restartPolicy: Never
      containers:
        - name: migration
          image: alpine:latest
          command:
            - /bin/sh
            - -c
            - |
              # Install rsync
              apk add --no-cache rsync

              echo "Starting migration from hostPath to Longhorn PVC..."
              echo "Source (hostPath): $(ls -la /source/)"
              echo "Destination (Longhorn): $(ls -la /destination/)"

              # Sync all data from hostPath to Longhorn PVC with progress
              rsync -azvPh --progress --delete /source/ /destination/

              # List contents for verification
              echo "Source contents:"
              cd /source
              du -hs *
              echo "Destination contents:"
              cd /destination
              du -hs *

              echo "Migration job completed successfully!"
          volumeMounts:
            - name: source-data
              mountPath: /source
              readOnly: true
            - name: destination-data
              mountPath: /destination
      volumes:
        - name: source-data
          hostPath:
            path: /home/player/kube_data/jellyfin/cache
            type: Directory
        - name: destination-data
          persistentVolumeClaim:
            claimName: jellyfin-cache
