---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: immich
spec:
  instances: 1
  imageName: ghcr.io/immich-app/postgres:16-vectorchord0.3.0-pgvectors0.2.0
  primaryUpdateStrategy: unsupervised

  mode: recovery
  recovery:
    method: pg_basebackup
    database: immich
    owner: immich
    pgBaseBackup:
      database: immich
      source:
        host: '10.99.99.5'
        port: 5432
        username: 'immich'
        database: 'immich'
        sslMode: 'disable'
        passwordSecret:
          name: 'immich-database-password'
  storage:
    size: 5Gi
    storageClass: local-path
  walStorage:
    enabled: true
    size: 1Gi
    storageClass: local-path
  logLevel: debug

  # -- When this option is enabled, the operator will use the SuperuserSecret to update the postgres user password.
  # If the secret is not present, the operator will automatically create one.
  # When this option is disabled, the operator will ignore the SuperuserSecret content, delete it when automatically created,
  # and then blank the password of the postgres user by setting it to NULL.
  enableSuperuserAccess: true
  superuserSecret:
    name: cnpg-superuser

  monitoring:
    enablePodMonitor: true
  # https://github.com/cloudnative-pg/cloudnative-pg/issues/2570
  enablePDB: false
  resources:
    requests:
      memory: '512Mi'
    limits:
      memory: '2Gi'
